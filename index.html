<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å›½å®é…’æ°´æ—¥é…æŸ¥è¯¢ç³»ç»Ÿ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif; background: #f5f5f5; color: #333; line-height: 1.6; padding: 20px; }
        .container { max-width: 600px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 2px solid #4CAF50; }
        .header h1 { color: #2c3e50; font-size: 1.5rem; margin-bottom: 8px; }
        .tabs { display: flex; background: white; border-radius: 12px; margin-bottom: 20px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .tab { flex: 1; padding: 15px; text-align: center; font-weight: 500; cursor: pointer; transition: all 0.3s; border-bottom: 3px solid transparent; }
        .tab.active { color: #4CAF50; border-bottom: 3px solid #4CAF50; background: #f8fff8; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .section { background: white; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 3px 10px rgba(0,0,0,0.08); }
        .input-group { display: flex; gap: 10px; margin-bottom: 15px; }
        .barcode-input { flex: 1; padding: 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px; }
        .btn { padding: 15px 25px; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; }
        .btn-primary { background: #4CAF50; color: white; }
        .btn-secondary { background: #2196F3; color: white; }
        .btn-warning { background: #ff9800; color: white; }
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px; }
        .info-item { padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #4CAF50; }
        .info-label { display: block; font-size: 0.85rem; color: #7f8c8d; margin-bottom: 5px; font-weight: 500; }
        .info-value { font-size: 1rem; color: #2c3e50; font-weight: 500; }
        .price-info { text-align: center; font-size: 1.4rem; color: #4CAF50; font-weight: 700; margin-top: 5px; }
        .file-upload-area { border: 2px dashed #4CAF50; border-radius: 12px; padding: 40px 20px; text-align: center; background: #f8fff8; cursor: pointer; }
        .file-input { display: none; }
        .data-stats { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-top: 20px; }
        .stat-item { background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center; }
        .stat-value { font-size: 1.8rem; font-weight: 700; color: #4CAF50; margin-bottom: 5px; }
        .stat-label { font-size: 0.9rem; color: #7f8c8d; }
        .instructions { background: #e3f2fd; border-radius: 8px; padding: 15px; margin-top: 20px; font-size: 0.9rem; color: #1565C0; }
        .alert { padding: 12px 15px; border-radius: 8px; margin: 15px 0; display: none; }
        .alert-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .alert-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .alert-warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .loading { display: none; text-align: center; padding: 20px; }
        .multiple-matches { margin-top: 20px; padding: 15px; background: #fff8e1; border-radius: 8px; border-left: 4px solid #ffc107; }
        .match-item { padding: 10px; margin: 5px 0; background: white; border-radius: 6px; cursor: pointer; transition: all 0.3s; }
        .match-item:hover { background: #f5f5f5; }
        .match-barcode { font-weight: bold; color: #333; }
        .match-name { color: #666; font-size: 0.9rem; }
        .share-package { text-align: center; padding: 30px 20px; }
        .package-info { display: none; margin-top: 20px; padding: 15px; background: #e8f5e9; border-radius: 8px; }
        @media (max-width: 768px) { .info-grid { grid-template-columns: 1fr; } .data-stats { grid-template-columns: 1fr 1fr; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“± å›½å®é…’æ°´æ—¥é…åº“å­˜æŸ¥è¯¢ç³»ç»Ÿ</h1>
            <div>æ•°æ®ç‰ˆæœ¬: <span id="dataVersion">-</span></div>
        </div>
        
        <div class="tabs">
            <div class="tab active" data-tab="search">ğŸ” æŸ¥è¯¢</div>
            <div class="tab" data-tab="import">ğŸ“Š æ•°æ®ç®¡ç†</div>
            <div class="tab" data-tab="share">ğŸ“¤ åˆ†äº«</div>
        </div>
        
        <!-- æŸ¥è¯¢æ ‡ç­¾é¡µ -->
        <div class="tab-content active" id="searchTab">
            <div class="section">
                <div class="input-group">
                    <input type="text" class="barcode-input" id="barcodeInput" placeholder="è¾“å…¥å•†å“æ¡ç å6ä½æˆ–å®Œæ•´æ¡ç ..." autocomplete="off" maxlength="13">
                    <button class="btn btn-primary" id="searchBtn">æŸ¥è¯¢</button>
                </div>
                <div style="margin-top: 10px; font-size: 0.9rem; color: #666;">
                    ğŸ’¡ æ”¯æŒè¾“å…¥ï¼šå®Œæ•´13ä½æ¡ç ã€å6ä½ã€åº—å†…ç 
                </div>
            </div>
            
            <!-- å¤šä¸ªåŒ¹é…ç»“æœ -->
            <div class="section" id="multipleMatches" style="display: none;">
                <h3 style="margin-bottom: 15px;">âš ï¸ æ‰¾åˆ°å¤šä¸ªåŒ¹é…å•†å“</h3>
                <p style="color: #856404; margin-bottom: 15px;">
                    è¾“å…¥çš„å6ä½å¯¹åº”å¤šä¸ªå•†å“ï¼Œè¯·é€‰æ‹©æ­£ç¡®çš„å•†å“æˆ–è¾“å…¥å®Œæ•´æ¡ç ï¼š
                </p>
                <div id="matchesList"></div>
            </div>
            
            <!-- å•ä¸ªæŸ¥è¯¢ç»“æœ -->
            <div class="section" id="resultSection">
                <h3 style="margin-bottom: 15px;">ğŸ“‹ å•†å“ä¿¡æ¯</h3>
                <div class="info-grid">
                    <div class="info-item"><span class="info-label">ä¾›åº”å•†</span><div class="info-value" id="supplierInfo">-</div></div>
                    <div class="info-item"><span class="info-label">å•†å“åç§°</span><div class="info-value" id="productName">-</div></div>
                    <div class="info-item"><span class="info-label">å•†å“æ¡ç </span><div class="info-value" id="barcodeInfo">-</div></div>
                    <div class="info-item"><span class="info-label">åº—å†…ç </span><div class="info-value" id="internalCode">-</div></div>
                    <div class="info-item"><span class="info-label">åº“å­˜æ•°é‡</span><div class="info-value" id="stockInfo">-</div></div>
                    <div class="info-item"><span class="info-label">è§„æ ¼</span><div class="info-value" id="specInfo">-</div></div>
                    <div class="info-item"><span class="info-label">å•ä½</span><div class="info-value" id="unitInfo">-</div></div>
                    <div class="info-item" style="grid-column: span 2;"><span class="info-label">å”®ä»·</span><div class="price-info" id="priceInfo">Â¥ 0.00</div></div>
                </div>
            </div>
            
            <!-- æ— ç»“æœæç¤º -->
            <div class="section no-results" id="noResults" style="display: none;">
                <div style="text-align: center; padding: 40px 20px; color: #7f8c8d;">
                    <div>ğŸ”</div>
                    <h3>æœªæ‰¾åˆ°å•†å“ä¿¡æ¯</h3>
                    <p>è¯·æ£€æŸ¥æ¡ç æ˜¯å¦æ­£ç¡®ï¼Œæˆ–è¾“å…¥å®Œæ•´13ä½æ¡ç </p>
                </div>
            </div>
        </div>
        
        <!-- æ•°æ®ç®¡ç†æ ‡ç­¾é¡µ -->
        <div class="tab-content" id="importTab">
            <div class="section">
                <h3 style="margin-bottom: 15px;">ğŸ“ å¯¼å…¥Excelæ•°æ®</h3>
                <div class="file-upload-area" id="fileUploadArea">
                    <div>ğŸ“¤</div>
                    <h4>ç‚¹å‡»æˆ–æ‹–æ‹½Excelæ–‡ä»¶åˆ°è¿™é‡Œ</h4>
                    <p>æ”¯æŒ .xls æˆ– .xlsx æ ¼å¼</p>
                    <p style="color: #666; font-size: 0.9rem; margin-top: 10px;">
                        è¯·ç¡®ä¿Excelæ–‡ä»¶åŒ…å«ä»¥ä¸‹åˆ—ï¼šå•†å“ç¼–ç ã€åº—å†…ç ã€ä¾›åº”å•†ã€å•†å“å“åã€åº“å­˜æ•°é‡ã€å”®ä»·ç­‰
                    </p>
                    <input type="file" class="file-input" id="excelFile" accept=".xls,.xlsx">
                </div>
                
                <div id="loading" class="loading">
                    <div style="font-size: 2rem; margin-bottom: 10px;">â³</div>
                    <p>æ­£åœ¨è§£æExcelæ–‡ä»¶ï¼Œè¯·ç¨å€™...</p>
                </div>
                
                <div id="alertSuccess" class="alert alert-success" style="display: none;">
                    æ•°æ®å¯¼å…¥æˆåŠŸï¼å·²åŠ è½½ <span id="loadedCount">0</span> æ¡å•†å“è®°å½•ã€‚
                </div>
                
                <div id="alertError" class="alert alert-error" style="display: none;">
                    æ–‡ä»¶æ ¼å¼é”™è¯¯æˆ–è¯»å–å¤±è´¥ï¼Œè¯·æ£€æŸ¥Excelæ–‡ä»¶æ ¼å¼ã€‚
                </div>
                
                <div id="fileInfo" style="display: none; margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 8px;">
                    <p><strong>æ–‡ä»¶ä¿¡æ¯ï¼š</strong> <span id="fileName">-</span> (<span id="fileSize">-</span>)</p>
                    <p><strong>è§£æç»“æœï¼š</strong> å…± <span id="rowCount">0</span> è¡Œæ•°æ®ï¼ŒæˆåŠŸå¯¼å…¥ <span id="validRowCount">0</span> æ¡å•†å“è®°å½•</p>
                </div>
            </div>
            
            <div class="section">
                <h3 style="margin-bottom: 15px;">ğŸ“Š æ•°æ®ç»Ÿè®¡</h3>
                <div class="data-stats">
                    <div class="stat-item"><div class="stat-value" id="totalProducts">0</div><div class="stat-label">å•†å“æ€»æ•°</div></div>
                    <div class="stat-item"><div class="stat-value" id="lowStockCount">0</div><div class="stat-label">ä½åº“å­˜å•†å“</div></div>
                    <div class="stat-item" style="grid-column: span 2;"><div class="stat-value" id="lastUpdate">-</div><div class="stat-label">æœ€åæ›´æ–°</div></div>
                </div>
                
                <button class="btn btn-secondary" id="exportBtn" style="margin-top: 20px; width: 100%;">
                    å¯¼å‡ºå½“å‰æ•°æ®ä¸ºExcel
                </button>
                
                <button class="btn btn-warning" id="clearDataBtn" style="margin-top: 10px; width: 100%;">
                    æ¸…ç©ºæ‰€æœ‰æ•°æ®
                </button>
            </div>
        </div>
        
        <!-- åˆ†äº«æ ‡ç­¾é¡µ -->
        <div class="tab-content" id="shareTab">
            <div class="section share-package">
                <h3 style="margin-bottom: 15px;">ğŸ“¤ ç”Ÿæˆå®Œæ•´ç‰ˆåˆ†äº«åŒ…</h3>
                <div style="font-size: 3rem; color: #4CAF50; margin-bottom: 20px;">ğŸ“¦</div>
                <p>ç”Ÿæˆä¸€ä¸ªå®Œæ•´çš„å•æ–‡ä»¶HTMLï¼ŒåŒ…å«å½“å‰æ‰€æœ‰å•†å“æ•°æ®ã€‚</p>
                <p style="color: #666; margin: 15px 0;">åˆ†äº«ç»™ä»–äººåï¼Œå¯¹æ–¹ç›´æ¥æ‰“å¼€HTMLæ–‡ä»¶å³å¯ä½¿ç”¨ï¼Œæ— éœ€å¯¼å…¥Excelã€‚</p>
                
                <button class="btn btn-primary" id="generatePackageBtn" style="margin-top: 20px; padding: 20px; font-size: 1.1rem; width: 100%;">
                    ç”Ÿæˆå®Œæ•´ç‰ˆHTMLæ–‡ä»¶
                </button>
                
                <div id="packageInfo" class="package-info">
                    <p><strong>âœ… æ–‡ä»¶å·²ç”Ÿæˆï¼</strong></p>
                    <p>æ–‡ä»¶å¤§å°ï¼š<span id="packageSize">-</span></p>
                    <p>åŒ…å« <span id="packageProductCount">0</span> æ¡å•†å“è®°å½•</p>
                    <p>ç”Ÿæˆæ—¶é—´ï¼š<span id="packageTime">-</span></p>
                </div>
            </div>
            
            <div class="section">
                <h3 style="margin-bottom: 15px;">ğŸ”„ æ›´æ–°ç°æœ‰åˆ†äº«åŒ…</h3>
                <p>å¦‚æœä½ æœ‰ä¹‹å‰ç”Ÿæˆçš„HTMLæ–‡ä»¶ï¼Œå¯ä»¥åœ¨è¿™é‡Œæ›´æ–°æ•°æ®ï¼š</p>
                
                <div class="file-upload-area" id="htmlUploadArea" style="margin-top: 15px;">
                    <div>ğŸ“„</div>
                    <h4>ä¸Šä¼ å·²æœ‰çš„HTMLæ–‡ä»¶</h4>
                    <p>æˆ‘ä»¬å°†æå–å…¶ä¸­çš„æ•°æ®ï¼Œåˆå¹¶åˆ°å½“å‰ç³»ç»Ÿä¸­</p>
                    <input type="file" class="file-input" id="htmlFile" accept=".html">
                </div>
            </div>
            
            <div class="instructions">
                <h3>ğŸ’¡ åˆ†äº«è¯´æ˜</h3>
                <ul>
                    <li>ç”Ÿæˆçš„HTMLæ–‡ä»¶åŒ…å«æ‰€æœ‰å½“å‰å•†å“æ•°æ®</li>
                    <li>æ–‡ä»¶å¤§å°çº¦ <span id="estimatedSize">1-2MB</span>ï¼ˆå–å†³äºæ•°æ®é‡ï¼‰</li>
                    <li>æ”¯æŒé€šè¿‡å¾®ä¿¡ã€QQã€é‚®ä»¶ç­‰æ–¹å¼åˆ†äº«</li>
                    <li>å¯¹æ–¹åœ¨æ‰‹æœºæˆ–ç”µè„‘æµè§ˆå™¨ä¸­æ‰“å¼€å³å¯ä½¿ç”¨</li>
                    <li><strong>æ³¨æ„ï¼š</strong>åˆ†äº«åŒ…ä½¿ç”¨ç®€åŒ–ç‰ˆæŸ¥è¯¢åŠŸèƒ½ï¼Œåªèƒ½æŸ¥è¯¢ï¼Œä¸èƒ½å¯¼å…¥æ–°æ•°æ®</li>
                </ul>
            </div>
        </div>
        
        <div class="instructions">
            <h3>ğŸ“± ä½¿ç”¨è¯´æ˜</h3>
            <ul>
                <li><strong>æŸ¥è¯¢åŠŸèƒ½</strong>ï¼šæ”¯æŒè¾“å…¥å®Œæ•´13ä½æ¡ç ã€å6ä½æˆ–åº—å†…ç æŸ¥è¯¢</li>
                <li><strong>åå…­ä½æŸ¥è¯¢</strong>ï¼šè¾“å…¥æ¡ç å6ä½å¯å¿«é€ŸæŸ¥è¯¢ï¼Œå¦‚æœ‰å¤šä¸ªåŒ¹é…ä¼šæç¤ºé€‰æ‹©</li>
                <li><strong>æ•°æ®ç®¡ç†</strong>ï¼šå¯¼å…¥Excelæ–‡ä»¶æ›´æ–°åº“å­˜æ•°æ®</li>
                <li><strong>åˆ†äº«åŠŸèƒ½</strong>ï¼šç”ŸæˆåŒ…å«æœ€æ–°æ•°æ®çš„å®Œæ•´HTMLæ–‡ä»¶ï¼Œåˆ†äº«ç»™ä»–äººä½¿ç”¨</li>
                <li><strong>æ•°æ®å­˜å‚¨</strong>ï¼šæ•°æ®ä¿å­˜åœ¨æµè§ˆå™¨æœ¬åœ°ï¼Œæ”¯æŒç¦»çº¿ä½¿ç”¨</li>
            </ul>
        </div>
    </div>

    <!-- ä½¿ç”¨æ›´ç¨³å®šçš„Excelè§£æåº“ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <script>
    // ä¸»åº”ç”¨ç¨‹åºä»£ç 
    (function() {
        // å•†å“æ•°æ®å­˜å‚¨åœ¨æœ¬åœ°
        let productData = [];
        
        // DOMå…ƒç´ 
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        
        // æŸ¥è¯¢ç›¸å…³å…ƒç´ 
        const barcodeInput = document.getElementById('barcodeInput');
        const searchBtn = document.getElementById('searchBtn');
        const resultSection = document.getElementById('resultSection');
        const noResults = document.getElementById('noResults');
        const multipleMatches = document.getElementById('multipleMatches');
        const matchesList = document.getElementById('matchesList');
        const dataVersion = document.getElementById('dataVersion');
        
        // æ˜¾ç¤ºä¿¡æ¯å…ƒç´ 
        const supplierInfo = document.getElementById('supplierInfo');
        const productName = document.getElementById('productName');
        const barcodeInfo = document.getElementById('barcodeInfo');
        const internalCode = document.getElementById('internalCode');
        const stockInfo = document.getElementById('stockInfo');
        const specInfo = document.getElementById('specInfo');
        const unitInfo = document.getElementById('unitInfo');
        const priceInfo = document.getElementById('priceInfo');
        
        // å¯¼å…¥ç›¸å…³å…ƒç´ 
        const fileUploadArea = document.getElementById('fileUploadArea');
        const excelFile = document.getElementById('excelFile');
        const loading = document.getElementById('loading');
        const alertSuccess = document.getElementById('alertSuccess');
        const alertError = document.getElementById('alertError');
        const loadedCount = document.getElementById('loadedCount');
        const exportBtn = document.getElementById('exportBtn');
        const clearDataBtn = document.getElementById('clearDataBtn');
        const fileInfo = document.getElementById('fileInfo');
        const fileName = document.getElementById('fileName');
        const fileSize = document.getElementById('fileSize');
        const rowCount = document.getElementById('rowCount');
        const validRowCount = document.getElementById('validRowCount');
        
        // ç»Ÿè®¡å…ƒç´ 
        const totalProducts = document.getElementById('totalProducts');
        const lowStockCount = document.getElementById('lowStockCount');
        const lastUpdate = document.getElementById('lastUpdate');
        const estimatedSize = document.getElementById('estimatedSize');
        
        // åˆ†äº«ç›¸å…³å…ƒç´ 
        const generatePackageBtn = document.getElementById('generatePackageBtn');
        const htmlUploadArea = document.getElementById('htmlUploadArea');
        const htmlFile = document.getElementById('htmlFile');
        const packageInfo = document.getElementById('packageInfo');
        const packageSize = document.getElementById('packageSize');
        const packageProductCount = document.getElementById('packageProductCount');
        const packageTime = document.getElementById('packageTime');
        
        // ============ ä¿®å¤ï¼šæ•°æ®å­˜å‚¨å‡½æ•° ============
        function saveDataWithCompression() {
            try {
                // ä½¿ç”¨æ›´å¯é çš„æ•°æ®å­˜å‚¨æ–¹å¼
                const dataToSave = {
                    version: '1.0',
                    timestamp: new Date().toISOString(),
                    data: productData
                };
                
                // å°è¯•å¤šç§å­˜å‚¨æ–¹å¼
                localStorage.setItem('productData_v2', JSON.stringify(dataToSave));
                localStorage.setItem('productData_backup', JSON.stringify(productData));
                localStorage.setItem('lastUpdate', new Date().toLocaleString());
                
                console.log('æ•°æ®å·²ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨ï¼Œæ•°é‡:', productData.length);
                updateStats();
                return true;
            } catch (e) {
                console.error('ä¿å­˜æ•°æ®å¤±è´¥:', e);
                // å°è¯•ä½¿ç”¨æ›´å°çš„æ•°æ®åŒ…
                try {
                    const compressedData = productData.map(item => [
                        item.barcode,
                        item.internalCode,
                        item.supplier,
                        item.productName,
                        item.stock,
                        item.price,
                        item.spec,
                        item.unit
                    ]);
                    localStorage.setItem('productData_compressed', JSON.stringify(compressedData));
                    console.log('ä½¿ç”¨å‹ç¼©æ ¼å¼ä¿å­˜æ•°æ®æˆåŠŸ');
                    return true;
                } catch (e2) {
                    console.error('å‹ç¼©ä¿å­˜ä¹Ÿå¤±è´¥:', e2);
                    alert('æ•°æ®é‡è¿‡å¤§ï¼Œè¯·åˆ†æ‰¹å¯¼å…¥æ•°æ®');
                    return false;
                }
            }
        }
        
        function loadDataFromStorage() {
            try {
                // ä¼˜å…ˆå°è¯•æ–°ç‰ˆæ ¼å¼
                const savedData = localStorage.getItem('productData_v2');
                if (savedData) {
                    const parsed = JSON.parse(savedData);
                    if (parsed.data && Array.isArray(parsed.data)) {
                        productData = parsed.data;
                        console.log('ä»æ–°ç‰ˆå­˜å‚¨åŠ è½½äº†', productData.length, 'æ¡å•†å“è®°å½•');
                        updateDataVersion();
                        updateStats();
                        return;
                    }
                }
                
                // å°è¯•æ—§ç‰ˆæ ¼å¼
                const backupData = localStorage.getItem('productData_backup');
                if (backupData) {
                    productData = JSON.parse(backupData);
                    console.log('ä»å¤‡ä»½å­˜å‚¨åŠ è½½äº†', productData.length, 'æ¡å•†å“è®°å½•');
                    updateDataVersion();
                    updateStats();
                    return;
                }
                
                // å°è¯•å‹ç¼©æ ¼å¼
                const compressedData = localStorage.getItem('productData_compressed');
                if (compressedData) {
                    const compressed = JSON.parse(compressedData);
                    productData = compressed.map(item => ({
                        barcode: item[0] || '',
                        internalCode: item[1] || '',
                        supplier: item[2] || '',
                        productName: item[3] || '',
                        stock: item[4] || 0,
                        price: item[5] || 0,
                        spec: item[6] || '',
                        unit: item[7] || ''
                    }));
                    console.log('ä»å‹ç¼©å­˜å‚¨åŠ è½½äº†', productData.length, 'æ¡å•†å“è®°å½•');
                    updateDataVersion();
                    updateStats();
                    return;
                }
                
                console.log('æœ¬åœ°å­˜å‚¨ä¸­æ²¡æœ‰æ‰¾åˆ°æ•°æ®');
            } catch (e) {
                console.error('åŠ è½½æ•°æ®å¤±è´¥:', e);
                productData = [];
            }
        }
        
        function updateDataVersion() {
            const lastUpdateTime = localStorage.getItem('lastUpdate');
            if (lastUpdateTime) {
                dataVersion.textContent = lastUpdateTime;
            } else {
                dataVersion.textContent = 'æ— æ•°æ®';
            }
        }
        // ============ ä¿®å¤ç»“æŸ ============
        
        // æ ‡ç­¾é¡µåˆ‡æ¢
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const tabName = tab.getAttribute('data-tab');
                
                // æ›´æ–°æ ‡ç­¾æ ·å¼
                tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                // æ˜¾ç¤ºå¯¹åº”å†…å®¹
                tabContents.forEach(content => {
                    content.classList.remove('active');
                    if (content.id === tabName + 'Tab') {
                        content.classList.add('active');
                    }
                });
                
                // åˆ‡æ¢åˆ°æ•°æ®ç®¡ç†é¡µæ—¶æ›´æ–°ç»Ÿè®¡
                if (tabName === 'import') {
                    updateStats();
                }
                
                // åˆ‡æ¢åˆ°åˆ†äº«é¡µæ—¶æ›´æ–°é¢„ä¼°å¤§å°
                if (tabName === 'share') {
                    updateEstimatedSize();
                }
            });
        });
        
        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats() {
            totalProducts.textContent = productData.length;
            
            // è®¡ç®—ä½åº“å­˜å•†å“ï¼ˆåº“å­˜å°‘äº10ï¼‰
            const lowStock = productData.filter(item => item.stock < 10).length;
            lowStockCount.textContent = lowStock;
            
            // è·å–æœ€åæ›´æ–°æ—¶é—´
            const lastUpdateTime = localStorage.getItem('lastUpdate');
            if (lastUpdateTime) {
                lastUpdate.textContent = lastUpdateTime;
            } else {
                lastUpdate.textContent = 'ä»æœªæ›´æ–°';
            }
        }
        
        // æ›´æ–°é¢„ä¼°æ–‡ä»¶å¤§å°
        function updateEstimatedSize() {
            const size = Math.round(JSON.stringify(productData).length / 1024);
            estimatedSize.textContent = size < 1000 ? size + 'KB' : (size/1024).toFixed(1) + 'MB';
        }
        
        // æœç´¢å•†å“ - æ”¯æŒå6ä½æŸ¥è¯¢
        function searchProduct() {
            const input = barcodeInput.value.trim();
            
            if (!input) {
                alert('è¯·è¾“å…¥å•†å“æ¡ç å6ä½æˆ–å®Œæ•´æ¡ç ');
                return;
            }
            
            // éšè—æ‰€æœ‰ç»“æœåŒºåŸŸ
            resultSection.style.display = 'none';
            noResults.style.display = 'none';
            multipleMatches.style.display = 'none';
            
            // å…ˆå°è¯•å®Œå…¨åŒ¹é…ï¼ˆå®Œæ•´æ¡ç æˆ–åº—å†…ç ï¼‰
            const exactMatches = productData.filter(item => 
                item.barcode === input || item.internalCode === input
            );
            
            if (exactMatches.length === 1) {
                // å®Œå…¨åŒ¹é…åˆ°ä¸€ä¸ªå•†å“
                showProduct(exactMatches[0]);
                return;
            }
            
            // å¦‚æœæ²¡æœ‰å®Œå…¨åŒ¹é…ï¼Œå°è¯•å6ä½åŒ¹é…
            const lastSixMatches = [];
            
            productData.forEach(item => {
                // æ£€æŸ¥æ¡ç å6ä½
                if (item.barcode && item.barcode.length >= 6) {
                    const lastSix = item.barcode.slice(-6);
                    if (lastSix === input) {
                        lastSixMatches.push(item);
                    }
                }
                
                // æ£€æŸ¥åº—å†…ç å6ä½
                if (item.internalCode && item.internalCode.length >= 6) {
                    const lastSix = item.internalCode.slice(-6);
                    if (lastSix === input) {
                        lastSixMatches.push(item);
                    }
                }
            });
            
            // å»é‡ï¼ˆé¿å…æ¡ç å’Œåº—å†…ç å6ä½ç›¸åŒå¯¼è‡´é‡å¤ï¼‰
            const uniqueMatches = [];
            const seen = new Set();
            lastSixMatches.forEach(item => {
                const key = item.barcode || item.internalCode;
                if (!seen.has(key)) {
                    seen.add(key);
                    uniqueMatches.push(item);
                }
            });
            
            // å¤„ç†åŒ¹é…ç»“æœ
            if (uniqueMatches.length === 0) {
                // æ²¡æœ‰åŒ¹é…åˆ°ä»»ä½•å•†å“
                noResults.style.display = 'block';
            } else if (uniqueMatches.length === 1) {
                // å6ä½åŒ¹é…åˆ°ä¸€ä¸ªå•†å“
                showProduct(uniqueMatches[0]);
            } else {
                // åŒ¹é…åˆ°å¤šä¸ªå•†å“ï¼Œæ˜¾ç¤ºé€‰æ‹©åˆ—è¡¨
                showMultipleMatches(uniqueMatches, input);
            }
        }
        
        // æ˜¾ç¤ºå•ä¸ªå•†å“ä¿¡æ¯
        function showProduct(product) {
            // æ˜¾ç¤ºå•†å“ä¿¡æ¯
            supplierInfo.textContent = product.supplier || '-';
            productName.textContent = product.productName || '-';
            barcodeInfo.textContent = product.barcode || '-';
            internalCode.textContent = product.internalCode || '-';
            
            // è·å–åº“å­˜æ•°é‡ï¼Œå¦‚æœä¸ºç©ºåˆ™æ˜¾ç¤º0
            const stock = product.stock || 0;
            // è·å–å•ä½ï¼Œå¦‚æœä¸ºç©ºåˆ™ä½¿ç”¨é»˜è®¤å€¼"ä»¶"
            const unit = product.unit || 'ä»¶';
            // æ˜¾ç¤ºåº“å­˜å’Œå•ä½
            stockInfo.textContent = stock + ' ' + unit;
            
            specInfo.textContent = product.spec || '-';
            unitInfo.textContent = unit;
            
            // ä»·æ ¼æ ¼å¼åŒ–ï¼Œä¿ç•™ä¸¤ä½å°æ•°
            const price = product.price || 0;
            priceInfo.textContent = 'Â¥ ' + price.toFixed(2);
            
            // æ˜¾ç¤ºç»“æœåŒºåŸŸ
            resultSection.style.display = 'block';
            noResults.style.display = 'none';
            multipleMatches.style.display = 'none';
            barcodeInput.value = '';
            
            // æ»šåŠ¨åˆ°ç»“æœåŒºåŸŸ
            resultSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        
        // æ˜¾ç¤ºå¤šä¸ªåŒ¹é…ç»“æœ
        function showMultipleMatches(matches, inputCode) {
            // æ¸…ç©ºä¹‹å‰çš„åˆ—è¡¨
            matchesList.innerHTML = '';
            
            // åˆ›å»ºåŒ¹é…åˆ—è¡¨
            matches.forEach((product, index) => {
                const matchItem = document.createElement('div');
                matchItem.className = 'match-item';
                matchItem.innerHTML = `
                    <div class="match-barcode">${product.barcode || product.internalCode}</div>
                    <div class="match-name">${product.productName}</div>
                    <div style="font-size: 0.8rem; color: #999; margin-top: 5px;">
                        ä¾›åº”å•†: ${product.supplier || '-'} | åº“å­˜: ${product.stock || 0} ${product.unit || 'ä»¶'}
                    </div>
                `;
                
                // ç‚¹å‡»è¿™ä¸ªé¡¹ç›®ï¼Œæ˜¾ç¤ºè¯¥å•†å“çš„è¯¦ç»†ä¿¡æ¯
                matchItem.addEventListener('click', () => {
                    showProduct(product);
                });
                
                matchesList.appendChild(matchItem);
            });
            
            // æ˜¾ç¤ºå¤šä¸ªåŒ¹é…åŒºåŸŸ
            multipleMatches.style.display = 'block';
            
            // æ»šåŠ¨åˆ°åŒ¹é…åŒºåŸŸ
            multipleMatches.scrollIntoView({ behavior: 'smooth', block: 'start' });
            
            // æ˜¾ç¤ºæç¤ºä¿¡æ¯
            barcodeInput.value = inputCode;
        }
        
        // å¤„ç†Excelæ–‡ä»¶
        function handleExcelFile(file) {
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            loading.style.display = 'block';
            alertSuccess.style.display = 'none';
            alertError.style.display = 'none';
            fileInfo.style.display = 'none';
            
            // æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
            fileName.textContent = file.name;
            const sizeInKB = (file.size / 1024).toFixed(2);
            fileSize.textContent = sizeInKB + ' KB';
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    
                    // ä½¿ç”¨XLSXåº“è§£æExcelæ–‡ä»¶
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // è·å–ç¬¬ä¸€ä¸ªå·¥ä½œè¡¨
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    
                    // å°†å·¥ä½œè¡¨è½¬æ¢ä¸ºJSON
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    // æ˜¾ç¤ºè¡Œæ•°
                    rowCount.textContent = jsonData.length;
                    
                    // è§£ææ•°æ®ï¼ˆå‡è®¾ç¬¬ä¸€è¡Œæ˜¯æ ‡é¢˜è¡Œï¼‰
                    if (jsonData.length < 2) {
                        throw new Error('Excelæ–‡ä»¶æ•°æ®ä¸ºç©º');
                    }
                    
                    // è·å–æ ‡é¢˜è¡Œ
                    const headers = jsonData[0];
                    
                    console.log('Excelæ ‡é¢˜è¡Œ:', headers);
                    
                    // æŸ¥æ‰¾åˆ—ç´¢å¼•ï¼ˆæ”¯æŒå¤šç§åˆ—åï¼‰
                    function findColumnIndex(possibleNames) {
                        for (let name of possibleNames) {
                            const index = headers.findIndex(h => 
                                h && h.toString().toLowerCase().includes(name.toLowerCase())
                            );
                            if (index !== -1) return index;
                        }
                        return -1;
                    }
                    
                    const barcodeIndex = findColumnIndex(['å•†å“ç¼–ç ', 'å•†å“æ¡ç ', 'æ¡å½¢ç ', 'æ¡ç ', 'å•†å“ç¼–ç ', 'ç¼–ç ']);
                    const internalCodeIndex = findColumnIndex(['åº—å†…ç ', 'ç¼–ç ', 'å†…éƒ¨ç¼–ç ']);
                    const supplierIndex = findColumnIndex(['ä¾›åº”å•†', 'ä¾›è´§å•†', 'ä¾›åº”æ–¹']);
                    const nameIndex = findColumnIndex(['å•†å“å“å', 'å•†å“åç§°', 'å“å', 'åç§°']);
                    const stockIndex = findColumnIndex(['åº“å­˜æ•°é‡', 'åº“å­˜', 'åº“å­˜æ•°', 'æ•°é‡']);
                    const priceIndex = findColumnIndex(['å”®ä»·', 'ä»·æ ¼', 'é”€å”®ä»·', 'å•ä»·']);
                    const specIndex = findColumnIndex(['è§„æ ¼', 'è§„æ ¼å‹å·', 'å‹å·']);
                    const unitIndex = findColumnIndex(['å•ä½', 'è®¡é‡å•ä½']);
                    
                    console.log('æ‰¾åˆ°çš„åˆ—ç´¢å¼•:', {
                        barcodeIndex, internalCodeIndex, supplierIndex, 
                        nameIndex, stockIndex, priceIndex, specIndex, unitIndex
                    });
                    
                    // æ£€æŸ¥å¿…è¦åˆ—æ˜¯å¦å­˜åœ¨
                    if (barcodeIndex === -1 && internalCodeIndex === -1) {
                        throw new Error('Excelæ–‡ä»¶ä¸­æ‰¾ä¸åˆ°å•†å“ç¼–ç æˆ–åº—å†…ç åˆ—');
                    }
                    
                    // åˆ›å»ºæ–°æ•°ç»„ï¼Œä¸æ¸…ç©ºç°æœ‰æ•°æ®ï¼ˆå…è®¸åˆå¹¶ï¼‰
                    const newProductData = [];
                    
                    // å¤„ç†æ¯ä¸€è¡Œæ•°æ®ï¼ˆä»ç¬¬äºŒè¡Œå¼€å§‹ï¼‰
                    let validCount = 0;
                    for (let i = 1; i < jsonData.length; i++) {
                        const row = jsonData[i];
                        
                        if (!row || row.length === 0) continue;
                        
                        // è·å–å„åˆ—æ•°æ®
                        const barcode = barcodeIndex !== -1 && row[barcodeIndex] ? 
                            String(row[barcodeIndex]).trim() : '';
                        const internalCode = internalCodeIndex !== -1 && row[internalCodeIndex] ? 
                            String(row[internalCodeIndex]).trim() : '';
                        const supplier = supplierIndex !== -1 && row[supplierIndex] ? 
                            String(row[supplierIndex]).trim() : '';
                        const productName = nameIndex !== -1 && row[nameIndex] ? 
                            String(row[nameIndex]).trim() : '';
                        const stock = stockIndex !== -1 && row[stockIndex] ? 
                            parseFloat(row[stockIndex]) || 0 : 0;
                        const price = priceIndex !== -1 && row[priceIndex] ? 
                            parseFloat(row[priceIndex]) || 0 : 0;
                        const spec = specIndex !== -1 && row[specIndex] ? 
                            String(row[specIndex]).trim() : '';
                        const unit = unitIndex !== -1 && row[unitIndex] ? 
                            String(row[unitIndex]).trim() : '';
                        
                        // å¦‚æœæœ‰æœ‰æ•ˆçš„æ¡ç æˆ–åº—å†…ç ï¼Œåˆ™æ·»åŠ åˆ°æ•°æ®ä¸­
                        if (barcode || internalCode) {
                            newProductData.push({
                                barcode,
                                internalCode,
                                supplier,
                                productName,
                                stock,
                                price,
                                spec,
                                unit
                            });
                            validCount++;
                        }
                    }
                    
                    // æ›´æ–°äº§å“æ•°æ®ï¼ˆæ›¿æ¢åŸæœ‰æ•°æ®ï¼‰
                    productData = newProductData;
                    
                    // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨ - ä½¿ç”¨ä¿®å¤åçš„å‡½æ•°
                    if (saveDataWithCompression()) {
                        // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                        loadedCount.textContent = validCount;
                        validRowCount.textContent = validCount;
                        alertSuccess.style.display = 'block';
                        alertError.style.display = 'none';
                        fileInfo.style.display = 'block';
                        
                        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
                        updateStats();
                        updateEstimatedSize();
                        
                        console.log('æˆåŠŸå¯¼å…¥', validCount, 'æ¡å•†å“è®°å½•');
                    } else {
                        alert('æ•°æ®ä¿å­˜å¤±è´¥ï¼Œè¯·å‡å°‘æ•°æ®é‡é‡è¯•');
                    }
                    
                } catch (error) {
                    console.error('è§£æExcelæ–‡ä»¶å¤±è´¥:', error);
                    alertError.innerHTML = `æ–‡ä»¶æ ¼å¼é”™è¯¯æˆ–è¯»å–å¤±è´¥: ${error.message}`;
                    alertError.style.display = 'block';
                    alertSuccess.style.display = 'none';
                    fileInfo.style.display = 'none';
                } finally {
                    // éšè—åŠ è½½çŠ¶æ€
                    loading.style.display = 'none';
                }
            };
            
            reader.onerror = function() {
                loading.style.display = 'none';
                alertError.textContent = 'è¯»å–æ–‡ä»¶å¤±è´¥ï¼Œè¯·é‡è¯•';
                alertError.style.display = 'block';
                alertSuccess.style.display = 'none';
                fileInfo.style.display = 'none';
            };
            
            // å¼€å§‹è¯»å–æ–‡ä»¶
            reader.readAsArrayBuffer(file);
        }
        
        // æ–‡ä»¶ä¸Šä¼ åŒºåŸŸç‚¹å‡»äº‹ä»¶
        fileUploadArea.addEventListener('click', () => {
            excelFile.click();
        });
        
        htmlUploadArea.addEventListener('click', () => {
            htmlFile.click();
        });
        
        // æ‹–æ”¾æ–‡ä»¶æ”¯æŒ
        [fileUploadArea, htmlUploadArea].forEach(area => {
            area.addEventListener('dragover', (e) => {
                e.preventDefault();
                area.style.background = '#e8f5e9';
            });
            
            area.addEventListener('dragleave', () => {
                area.style.background = '#f8fff8';
            });
            
            area.addEventListener('drop', (e) => {
                e.preventDefault();
                area.style.background = '#f8fff8';
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    if (area === fileUploadArea && (files[0].name.endsWith('.xls') || files[0].name.endsWith('.xlsx'))) {
                        handleExcelFile(files[0]);
                    } else if (area === htmlUploadArea && files[0].name.endsWith('.html')) {
                        extractDataFromHTML(files[0]);
                    } else {
                        alert('è¯·é€‰æ‹©æ­£ç¡®çš„æ–‡ä»¶ç±»å‹');
                    }
                }
            });
        });
        
        // æ–‡ä»¶é€‰æ‹©å˜åŒ–äº‹ä»¶
        excelFile.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file && (file.name.endsWith('.xls') || file.name.endsWith('.xlsx'))) {
                handleExcelFile(file);
            } else {
                alert('è¯·é€‰æ‹©Excelæ–‡ä»¶ (.xls æˆ– .xlsx)');
            }
            e.target.value = '';
        });
        
        // ä»HTMLæ–‡ä»¶ä¸­æå–æ•°æ®
        function extractDataFromHTML(file) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const htmlContent = e.target.result;
                    // åœ¨HTMLå†…å®¹ä¸­æŸ¥æ‰¾productData
                    const match = htmlContent.match(/var productData = (\[.*?\]);/s);
                    
                    if (match && match[1]) {
                        const extractedData = JSON.parse(match[1]);
                        productData = extractedData;
                        saveDataWithCompression();
                        alert('æˆåŠŸä»HTMLæ–‡ä»¶å¯¼å…¥ ' + productData.length + ' æ¡å•†å“è®°å½•');
                        updateStats();
                        updateEstimatedSize();
                    } else {
                        alert('æœªåœ¨HTMLæ–‡ä»¶ä¸­æ‰¾åˆ°å•†å“æ•°æ®');
                    }
                } catch (error) {
                    console.error('è§£æHTMLæ–‡ä»¶å¤±è´¥:', error);
                    alert('è¯»å–HTMLæ–‡ä»¶å¤±è´¥: ' + error.message);
                }
            };
            
            reader.onerror = function() {
                alert('è¯»å–æ–‡ä»¶å¤±è´¥');
            };
            
            reader.readAsText(file);
        }
        
        htmlFile.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file && file.name.endsWith('.html')) {
                extractDataFromHTML(file);
            } else {
                alert('è¯·é€‰æ‹©HTMLæ–‡ä»¶');
            }
            e.target.value = '';
        });
        
        // å¯¼å‡ºæ•°æ®ä¸ºExcel
        exportBtn.addEventListener('click', () => {
            if (productData.length === 0) {
                alert('å½“å‰æ²¡æœ‰æ•°æ®å¯å¯¼å‡º');
                return;
            }
            
            try {
                // åˆ›å»ºå·¥ä½œè¡¨æ•°æ®
                const wsData = [
                    ['å•†å“ç¼–ç ', 'åº—å†…ç ', 'ä¾›åº”å•†', 'å•†å“å“å', 'åº“å­˜æ•°é‡', 'å”®ä»·', 'è§„æ ¼', 'å•ä½']
                ];
                
                productData.forEach(item => {
                    wsData.push([
                        item.barcode,
                        item.internalCode,
                        item.supplier,
                        item.productName,
                        item.stock,
                        item.price,
                        item.spec,
                        item.unit
                    ]);
                });
                
                // åˆ›å»ºå·¥ä½œè¡¨
                const ws = XLSX.utils.aoa_to_sheet(wsData);
                
                // åˆ›å»ºå·¥ä½œç°¿
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'å•†å“æ•°æ®');
                
                // ç”ŸæˆExcelæ–‡ä»¶å¹¶ä¸‹è½½
                const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
                const blob = new Blob([wbout], { type: 'application/octet-stream' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `å•†å“æ•°æ®_${new Date().toISOString().split('T')[0]}.xlsx`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                URL.revokeObjectURL(url);
                
            } catch (error) {
                console.error('å¯¼å‡ºæ•°æ®å¤±è´¥:', error);
                alert('å¯¼å‡ºæ•°æ®å¤±è´¥: ' + error.message);
            }
        });
        
        // æ¸…ç©ºæ•°æ®
        clearDataBtn.addEventListener('click', () => {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å•†å“æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼')) {
                productData = [];
                // æ¸…ç©ºæ‰€æœ‰å­˜å‚¨ç‰ˆæœ¬
                localStorage.removeItem('productData_v2');
                localStorage.removeItem('productData_backup');
                localStorage.removeItem('productData_compressed');
                localStorage.removeItem('lastUpdate');
                
                updateStats();
                updateEstimatedSize();
                updateDataVersion();
                alert('æ•°æ®å·²æ¸…ç©º');
            }
        });
        
        // ç”Ÿæˆå®Œæ•´ç‰ˆHTMLåŒ…
        generatePackageBtn.addEventListener('click', () => {
            if (productData.length === 0) {
                alert('å½“å‰æ²¡æœ‰å•†å“æ•°æ®ï¼Œè¯·å…ˆå¯¼å…¥Excelæ•°æ®');
                return;
            }
            
            // åˆ›å»ºåˆ†äº«åŒ…HTMLå†…å®¹
            const shareHTML = createSharePackage();
            
            // åˆ›å»ºBlobå¹¶ä¸‹è½½
            const blob = new Blob([shareHTML], { type: 'text/html;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `å•†å“æŸ¥è¯¢ç³»ç»Ÿ_${new Date().toISOString().split('T')[0]}_${productData.length}æ¡.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            URL.revokeObjectURL(url);
            
            // æ˜¾ç¤ºåŒ…ä¿¡æ¯
            const size = (blob.size / 1024).toFixed(1);
            packageSize.textContent = size + ' KB';
            packageProductCount.textContent = productData.length;
            packageTime.textContent = new Date().toLocaleString();
            packageInfo.style.display = 'block';
            
            // æ»šåŠ¨åˆ°åŒ…ä¿¡æ¯
            packageInfo.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        });
        
        // åˆ›å»ºåˆ†äº«åŒ…HTML
        function createSharePackage() {
            const now = new Date();
            return `<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å•†å“æ¡ç æŸ¥è¯¢ç³»ç»Ÿ - ${now.toLocaleDateString()} æ•°æ®ç‰ˆ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif; background: #f5f5f5; color: #333; line-height: 1.6; padding: 20px; }
        .container { max-width: 600px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 2px solid #4CAF50; }
        .header h1 { color: #2c3e50; font-size: 1.5rem; margin-bottom: 8px; }
        .section { background: white; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 3px 10px rgba(0,0,0,0.08); }
        .input-group { display: flex; gap: 10px; margin-bottom: 15px; }
        .barcode-input { flex: 1; padding: 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px; }
        .btn { padding: 15px 25px; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; background: #4CAF50; color: white; }
        .btn:active { background: #388E3C; transform: scale(0.98); }
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px; }
        .info-item { padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #4CAF50; }
        .info-label { display: block; font-size: 0.85rem; color: #7f8c8d; margin-bottom: 5px; font-weight: 500; }
        .info-value { font-size: 1rem; color: #2c3e50; font-weight: 500; }
        .price-info { text-align: center; font-size: 1.4rem; color: #4CAF50; font-weight: 700; margin-top: 5px; }
        .instructions { background: #e3f2fd; border-radius: 8px; padding: 15px; margin-top: 20px; font-size: 0.9rem; color: #1565C0; }
        .multiple-matches { margin-top: 20px; padding: 15px; background: #fff8e1; border-radius: 8px; border-left: 4px solid #ffc107; }
        .match-item { padding: 10px; margin: 5px 0; background: white; border-radius: 6px; cursor: pointer; transition: all 0.3s; }
        .match-item:hover { background: #f5f5f5; }
        .match-barcode { font-weight: bold; color: #333; }
        .match-name { color: #666; font-size: 0.9rem; }
        @media (max-width: 768px) { .info-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“± å•†å“æ¡ç æŸ¥è¯¢ç³»ç»Ÿ</h1>
            <div>æ•°æ®ç‰ˆæœ¬: ${now.toLocaleDateString()} | å•†å“æ€»æ•°: ${productData.length} æ¡</div>
        </div>
        
        <div class="section">
            <div class="input-group">
                <input type="text" class="barcode-input" id="barcodeInput" placeholder="è¾“å…¥å•†å“æ¡ç å6ä½æˆ–å®Œæ•´æ¡ç ..." autocomplete="off" maxlength="13">
                <button class="btn" id="searchBtn">æŸ¥è¯¢</button>
            </div>
            <div style="margin-top: 10px; font-size: 0.9rem; color: #666;">
                ğŸ’¡ æ”¯æŒè¾“å…¥ï¼šå®Œæ•´13ä½æ¡ç ã€å6ä½ã€åº—å†…ç 
            </div>
        </div>
        
        <!-- å¤šä¸ªåŒ¹é…ç»“æœ -->
        <div class="section" id="multipleMatches" style="display: none;">
            <h3 style="margin-bottom: 15px;">âš ï¸ æ‰¾åˆ°å¤šä¸ªåŒ¹é…å•†å“</h3>
            <p style="color: #856404; margin-bottom: 15px;">
                è¾“å…¥çš„å6ä½å¯¹åº”å¤šä¸ªå•†å“ï¼Œè¯·é€‰æ‹©æ­£ç¡®çš„å•†å“æˆ–è¾“å…¥å®Œæ•´æ¡ç ï¼š
            </p>
            <div id="matchesList"></div>
        </div>
        
        <!-- å•ä¸ªæŸ¥è¯¢ç»“æœ -->
        <div class="section" id="resultSection" style="display: none;">
            <h3 style="margin-bottom: 15px;">ğŸ“‹ å•†å“ä¿¡æ¯</h3>
            <div class="info-grid">
                <div class="info-item"><span class="info-label">ä¾›åº”å•†</span><div class="info-value" id="supplierInfo">-</div></div>
                <div class="info-item"><span class="info-label">å•†å“åç§°</span><div class="info-value" id="productName">-</div></div>
                <div class="info-item"><span class="info-label">å•†å“æ¡ç </span><div class="info-value" id="barcodeInfo">-</div></div>
                <div class="info-item"><span class="info-label">åº—å†…ç </span><div class="info-value" id="internalCode">-</div></div>
                <div class="info-item"><span class="info-label">åº“å­˜æ•°é‡</span><div class="info-value" id="stockInfo">-</div></div>
                <div class="info-item"><span class="info-label">è§„æ ¼</span><div class="info-value" id="specInfo">-</div></div>
                <div class="info-item"><span class="info-label">å•ä½</span><div class="info-value" id="unitInfo">-</div></div>
                <div class="info-item" style="grid-column: span 2;"><span class="info-label">å”®ä»·</span><div class="price-info" id="priceInfo">Â¥ 0.00</div></div>
            </div>
        </div>
        
        <!-- æ— ç»“æœæç¤º -->
        <div class="section no-results" id="noResults" style="display: none;">
            <div style="text-align: center; padding: 40px 20px; color: #7f8c8d;">
                <div>ğŸ”</div>
                <h3>æœªæ‰¾åˆ°å•†å“ä¿¡æ¯</h3>
                <p>è¯·æ£€æŸ¥æ¡ç æ˜¯å¦æ­£ç¡®ï¼Œæˆ–è¾“å…¥å®Œæ•´13ä½æ¡ç </p>
            </div>
        </div>
        
        <div class="instructions">
            <h3>ğŸ“± ä½¿ç”¨è¯´æ˜</h3>
            <ul>
                <li>åœ¨è¾“å…¥æ¡†ä¸­è¾“å…¥å•†å“æ¡ç å6ä½æˆ–å®Œæ•´æ¡ç è¿›è¡ŒæŸ¥è¯¢</li>
                <li>æ­¤ç‰ˆæœ¬ä¸ºåªè¯»ç‰ˆæœ¬ï¼ŒåŒ…å« ${productData.length} æ¡å•†å“è®°å½•</li>
                <li>æ•°æ®ç‰ˆæœ¬: ${now.toLocaleDateString()}</li>
                <li>å¦‚éœ€æ›´æ–°æ•°æ®ï¼Œè¯·è”ç³»æ•°æ®ç®¡ç†å‘˜è·å–æ–°ç‰ˆæ–‡ä»¶</li>
                <li>æ”¯æŒåœ¨æ‰‹æœºå’Œç”µè„‘æµè§ˆå™¨ä¸­ä½¿ç”¨</li>
            </ul>
        </div>
    </div>

    <script>
        // å•†å“æ•°æ®ï¼ˆå·²å†…åµŒåœ¨æ–‡ä»¶ä¸­ï¼‰
        var productData = ${JSON.stringify(productData)};
        
        document.addEventListener('DOMContentLoaded', function() {
            const barcodeInput = document.getElementById('barcodeInput');
            const searchBtn = document.getElementById('searchBtn');
            const resultSection = document.getElementById('resultSection');
            const noResults = document.getElementById('noResults');
            const multipleMatches = document.getElementById('multipleMatches');
            const matchesList = document.getElementById('matchesList');
            
            // æœç´¢åŠŸèƒ½
            function searchProduct() {
                const input = barcodeInput.value.trim();
                
                if (!input) {
                    alert('è¯·è¾“å…¥å•†å“æ¡ç å6ä½æˆ–å®Œæ•´æ¡ç ');
                    return;
                }
                
                // éšè—æ‰€æœ‰ç»“æœåŒºåŸŸ
                resultSection.style.display = 'none';
                noResults.style.display = 'none';
                multipleMatches.style.display = 'none';
                
                // å…ˆå°è¯•å®Œå…¨åŒ¹é…ï¼ˆå®Œæ•´æ¡ç æˆ–åº—å†…ç ï¼‰
                const exactMatches = productData.filter(item => 
                    item.barcode === input || item.internalCode === input
                );
                
                if (exactMatches.length === 1) {
                    showProduct(exactMatches[0]);
                    return;
                }
                
                // å¦‚æœæ²¡æœ‰å®Œå…¨åŒ¹é…ï¼Œå°è¯•å6ä½åŒ¹é…
                const lastSixMatches = [];
                
                productData.forEach(item => {
                    if (item.barcode && item.barcode.length >= 6) {
                        const lastSix = item.barcode.slice(-6);
                        if (lastSix === input) {
                            lastSixMatches.push(item);
                        }
                    }
                    
                    if (item.internalCode && item.internalCode.length >= 6) {
                        const lastSix = item.internalCode.slice(-6);
                        if (lastSix === input) {
                            lastSixMatches.push(item);
                        }
                    }
                });
                
                // å»é‡
                const uniqueMatches = [];
                const seen = new Set();
                lastSixMatches.forEach(item => {
                    const key = item.barcode || item.internalCode;
                    if (!seen.has(key)) {
                        seen.add(key);
                        uniqueMatches.push(item);
                    }
                });
                
                // å¤„ç†åŒ¹é…ç»“æœ
                if (uniqueMatches.length === 0) {
                    noResults.style.display = 'block';
                } else if (uniqueMatches.length === 1) {
                    showProduct(uniqueMatches[0]);
                } else {
                    showMultipleMatches(uniqueMatches, input);
                }
            }
            
            // æ˜¾ç¤ºå•ä¸ªå•†å“
            function showProduct(product) {
                document.getElementById('supplierInfo').textContent = product.supplier || '-';
                document.getElementById('productName').textContent = product.productName || '-';
                document.getElementById('barcodeInfo').textContent = product.barcode || '-';
                document.getElementById('internalCode').textContent = product.internalCode || '-';
                
                const stock = product.stock || 0;
                const unit = product.unit || 'ä»¶';
                document.getElementById('stockInfo').textContent = stock + ' ' + unit;
                
                document.getElementById('specInfo').textContent = product.spec || '-';
                document.getElementById('unitInfo').textContent = unit;
                document.getElementById('priceInfo').textContent = 'Â¥ ' + (product.price || 0).toFixed(2);
                
                resultSection.style.display = 'block';
                noResults.style.display = 'none';
                multipleMatches.style.display = 'none';
                barcodeInput.value = '';
                
                resultSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
            
            // æ˜¾ç¤ºå¤šä¸ªåŒ¹é…
            function showMultipleMatches(matches, inputCode) {
                matchesList.innerHTML = '';
                
                matches.forEach((product, index) => {
                    const matchItem = document.createElement('div');
                    matchItem.className = 'match-item';
                    matchItem.innerHTML = \`
                        <div class="match-barcode">\${product.barcode || product.internalCode}</div>
                        <div class="match-name">\${product.productName}</div>
                        <div style="font-size: 0.8rem; color: #999; margin-top: 5px;">
                            ä¾›åº”å•†: \${product.supplier || '-'} | åº“å­˜: \${product.stock || 0} \${product.unit || 'ä»¶'}
                        </div>
                    \`;
                    
                    matchItem.addEventListener('click', () => {
                        showProduct(product);
                    });
                    
                    matchesList.appendChild(matchItem);
                });
                
                multipleMatches.style.display = 'block';
                multipleMatches.scrollIntoView({ behavior: 'smooth', block: 'start' });
                barcodeInput.value = inputCode;
            }
            
            searchBtn.addEventListener('click', searchProduct);
            barcodeInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') searchProduct();
            });
        });
    <\/script>
</body>
</html>`;
        }
        
        // äº‹ä»¶ç›‘å¬
        searchBtn.addEventListener('click', searchProduct);
        
        // æŒ‰å›è½¦é”®æœç´¢
        barcodeInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchProduct();
            }
        });
        
        // é¡µé¢åŠ è½½æ—¶ä»æœ¬åœ°å­˜å‚¨åŠ è½½æ•°æ®
        document.addEventListener('DOMContentLoaded', () => {
            loadDataFromStorage();
            
            // è®¾ç½®é»˜è®¤æ˜¾ç¤º
            resultSection.style.display = 'none';
            noResults.style.display = 'none';
            multipleMatches.style.display = 'none';
            loading.style.display = 'none';
        });
    })();
    </script>
</body>
</html>